<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">

<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
<meta http-equiv="Pragma" content="no-cache" />
<meta http-equiv="Expires" content="0" />

<style>
html, body {
  margin: 0;
  padding: 0;
  height: 100%;
  overflow: hidden;
}
#niraviewer {
  width: 100%;
  height: 100%;
  border: 0;
}
</style>

<script src="https://sdk.nira.app/js/viewer.js"></script>
</head>

<body>

<iframe
  id="niraviewer"
  src="https://nidaros.nira.app/g/y-93qFDYS2W-8ACrlqVj8A">
</iframe>

<script>

let viewerReady = false;

let viewer = new NiraAPI.Viewer(
  document.getElementById("niraviewer"),
  {
    showNavigationTools: true,
    showMeasureTool: true,
    showCalloutsList: true,
    showRenderModes: true,
    suppressCalloutDialog: true
  }
);

/* --------------------------------------------------
   Når modellen er ferdig lastet
-------------------------------------------------- */

viewer.on("asset_load_finish", function () {
  viewerReady = true;
});

/* --------------------------------------------------
   FileMaker → Viewer
-------------------------------------------------- */

function activateFromFileMaker(uuid) {

  if (!uuid) return;
  if (!viewerReady) return;

  try {
    if (viewer.activateCallout) {
      viewer.activateCallout(uuid);
      return;
    }

    if (viewer.setSessionState) {
      viewer.setSessionState({ activeCallout: uuid });
      return;
    }

    console.log("No supported activation method found.");

  } catch (e) {
    console.log("Activation failed:", e);
  }
}

/* --------------------------------------------------
   Viewer → FileMaker
-------------------------------------------------- */

viewer.on("callout_created", function (info) {
  if (info && info.uuid) {
    sendToFileMaker(info.uuid);
  }
});

viewer.on("callout_activated", function (info) {
  if (info && info.uuid) {
    sendToFileMaker(info.uuid);
  }
});

/* --------------------------------------------------
   Bridge til FileMaker
-------------------------------------------------- */

function sendToFileMaker(uuid) {

  if (!uuid) return;

  try {

    if (window.FileMaker && FileMaker.PerformScript) {
      FileMaker.PerformScript("Test_From_nira", uuid);
      return;
    }

    if (window.FileMaker && FileMaker.PerformScriptWithOption) {
      FileMaker.PerformScriptWithOption("Test_From_nira", uuid, 0);
      return;
    }

    if (window.parent && window.parent.FileMaker) {
      window.parent.FileMaker.PerformScriptWithOption("Test_From_nira", uuid, 0);
      return;
    }

  } catch (e) {
    console.log("Bridge error:", e);
  }
}

</script>

</body>
</html>
